{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Monokotil Shop</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="bg-gray-50 w-full min-h-screen pt-24">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-10 py-10">
    
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">New Monokotil Shop Products</h1>
        <p class="text-gray-600 mt-1">Stay updated with the latest in Monokotil Shop</p>
    </div>

    <div class="mb-8">
        <button id="create-product-main-btn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-md font-medium hover:bg-blue-700 transition-colors shadow-sm">
            Create Product by AJAX
        </button>
    </div>
    
    <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center mb-8">
        <div class="flex items-center gap-2 border border-gray-200 rounded-lg p-1">
            <button id="filter-all" class="filter-btn active-filter px-4 py-2 rounded-md text-sm font-semibold">All Products</button>
            <button id="filter-my-products" class="filter-btn inactive-filter px-4 py-2 rounded-md text-sm font-semibold">My Product</button>
        </div>
        <span class="text-sm text-gray-500">Last login: {{ last_login }}</span>
    </div>
    
    <div id="product_cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
      </div>
    
    <div id="loading-state" class="text-center py-12 hidden">
        <p class="text-gray-500 text-lg">Loading products...</p>
    </div>
    
    <div id="empty-state" class="col-span-full text-center py-16 px-6 bg-white rounded-lg border border-gray-200 hidden">
        <img src="https://i.imgur.com/39I3pM4.png" alt="No products available" class="mx-auto h-24 w-24 text-gray-400 mb-4">
        <h3 class="text-xl font-semibold text-gray-800">No products found</h3>
        <p class="mt-2 text-gray-500">Be the first to share products with the community.</p>
        <button id="create-product-empty-btn" class="mt-6 bg-blue-600 text-white px-5 py-2.5 rounded-md font-medium hover:bg-blue-700 transition-colors">
            Create Products
        </button>
    </div>

    <div id="error-state" class="col-span-full text-center py-12 hidden">
        <p class="text-red-600 text-lg">Something went wrong. Please try again.</p>
    </div>

  </div>
</div>

<div id="product-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg flex flex-col max-h-[90vh]">
        <div class="flex justify-between items-start p-6 border-b rounded-t shrink-0">
            <div>
                <h3 id="modal-title" class="text-xl font-semibold text-gray-900">Create New Product</h3>
                <p class="text-sm text-gray-500">Share your product with the community</p>
            </div>
            <button id="close-modal-btn" type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
        </div>

        <form id="product-form" class="flex flex-col overflow-hidden">
            <div class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="product-id" name="product_id">
                {% csrf_token %}
                {% for field in form %}
                <div>
                    <label for="{{ field.id_for_label }}" class="block mb-2 text-sm font-medium text-gray-900">{{ field.label }}</label>
                    {{ field }}
                </div>
                {% endfor %}
            </div>

            <div class="flex items-center justify-end space-x-4 p-6 border-t shrink-0">
                <button id="cancel-btn" type="button" class="px-5 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">Cancel</button>
                <button id="submit-btn" type="submit" class="px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Add Product</button>
            </div>
        </form>
    </div>
</div>


<div id="delete-confirm-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 shadow-xl">
        <h2 class="text-lg font-bold">Confirm Deletion</h2>
        <p class="my-4 text-gray-600">Are you sure you want to delete this product?</p>
        <div class="flex justify-end gap-4">
            <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
            <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
        </div>
    </div>
</div>
<div id="toast" class="fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-lg hidden transition-opacity duration-300">
    <p id="toast-message"></p>
</div>

<style>
    .active-filter { background-color: #2563eb; color: white; }
    .inactive-filter { background-color: transparent; color: #374151; }
    .inactive-filter:hover { background-color: #f3f4f6; }
</style>

<script>
let currentFilter = 'all';

async function getProducts(filterType = 'all') {
    document.getElementById('loading-state').classList.remove('hidden');
    const productCardsContainer = document.getElementById('product_cards');
    productCardsContainer.innerHTML = "";
    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('error-state').classList.add('hidden');

    const url = `{% url 'main:get_product_json' %}?filter=${filterType}`;
    
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("Network response was not ok");
        const products = await response.json();
        
        document.getElementById('loading-state').classList.add('hidden');
        if (products.length === 0) {
            document.getElementById('empty-state').classList.remove('hidden');
        } else {
            let htmlString = "";
            products.forEach((item) => {
                let thumbnailUrl = item.fields.thumbnail || 'https://i.imgur.com/7qC0VfJ.png';
                htmlString += `
                <article class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden flex flex-col group">
                    <div class="aspect-video relative">
                        <img src="${thumbnailUrl}" alt="${item.fields.name}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
                        <div class="absolute top-3 left-3">
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 capitalize">${item.fields.category}</span>
                        </div>`;
                if (item.fields.is_featured) {
                    htmlString += `
                        <div class="absolute top-3 right-3">
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">Featured</span>
                        </div>`;
                }
                htmlString += `
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <h3 class="text-lg font-bold text-gray-800 mb-1 leading-tight">${item.fields.name}</h3>
                        <p class="text-gray-600 text-sm mb-4 flex-grow">${item.fields.description}</p>
                        <div class="flex items-center text-sm text-gray-500 mb-4">
                            <span>Stocks: <b class="text-gray-700">${item.fields.stocks}</b></span>
                            <span class="mx-2">•</span>
                            <span>Rarity: <b class="text-yellow-500">${item.fields.rarity}⭐</b></span>
                        </div>
                        <div class="pt-4 border-t border-gray-100 mt-auto flex items-center justify-between">
                            <a href="/product/${item.pk}" class="text-blue-600 hover:text-blue-700 font-semibold text-sm group/link">
                                View Details <span class="inline-block transition-transform group-hover/link:translate-x-1">→</span>
                            </a>`;
                if (item.fields.user == {{ user.pk }}) {
                    htmlString += `
                        <div class="flex items-center gap-3">
                            <button class="edit-btn text-sm font-medium text-yellow-600 hover:text-yellow-700" data-id="${item.pk}">Edit</button>
                            <button class="delete-btn text-sm font-medium text-red-500 hover:text-red-700" data-id="${item.pk}">Delete</button>
                        </div>`;
                }
                htmlString += `</div></div></article>`;
            });
            productCardsContainer.innerHTML = htmlString;
        }
    } catch (error) {
        console.error("Error fetching products:", error);
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.remove('hidden');
    }
}

function showToast(message, type = "success") {
    const toast = document.getElementById("toast");
    const toastMessage = document.getElementById("toast-message");
    if (toast && toastMessage) {
        toastMessage.innerText = message;
        toast.className = `fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-lg transition-opacity duration-300 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
        toast.classList.remove("hidden");
        setTimeout(() => { toast.classList.add("hidden"); }, 3000);
    }
}

// --- MODAL LOGIC (CREATE & EDIT) ---
const modal = document.getElementById('product-modal');
const form = document.getElementById('product-form');
const modalTitle = document.getElementById('modal-title');
const submitBtn = document.getElementById('submit-btn');
const productIdInput = document.getElementById('product-id');

function openModalForCreate() {
    form.reset();
    productIdInput.value = '';
    modalTitle.textContent = 'Create New Product';
    submitBtn.textContent = 'Add Product';
    modal.classList.remove('hidden');
}

async function openModalForEdit(productId) {
    form.reset();
    try {
        const response = await fetch(`/json/${productId}/`);
        const data = await response.json();
        if (data.length === 0) throw new Error("Product not found");
        const product = data[0].fields;
        
        document.getElementById('id_name').value = product.name;
        document.getElementById('id_description').value = product.description;
        document.getElementById('id_category').value = product.category;
        document.getElementById('id_thumbnail').value = product.thumbnail || '';
        document.getElementById('id_price').value = product.price;
        document.getElementById('id_stocks').value = product.stocks;
        document.getElementById('id_rarity').value = product.rarity;
        document.getElementById('id_is_featured').checked = product.is_featured;
        
        productIdInput.value = data[0].pk;
        modalTitle.textContent = 'Edit Product';
        submitBtn.textContent = 'Update Product';
        modal.classList.remove('hidden');
    } catch (error) {
        console.error("Error fetching product for edit:", error);
        showToast("Gagal memuat data produk.", "error");
    }
}

function closeModal() {
    modal.classList.add('hidden');
}

// --- Event Listeners ---
document.addEventListener('DOMContentLoaded', () => { 
    getProducts(currentFilter); 

    const navCreateBtn = document.getElementById('nav-create-product-btn');
    if(navCreateBtn) {
        navCreateBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openModalForCreate();
        });
    }
});

document.getElementById('create-product-main-btn').addEventListener('click', openModalForCreate);
const filterAllBtn = document.getElementById('filter-all');
const filterMyProductsBtn = document.getElementById('filter-my-products');
filterAllBtn.addEventListener('click', () => {
    currentFilter = 'all';
    filterAllBtn.classList.replace('inactive-filter', 'active-filter');
    filterMyProductsBtn.classList.replace('active-filter', 'inactive-filter');
    getProducts(currentFilter);
});
filterMyProductsBtn.addEventListener('click', () => {
    currentFilter = 'my_products';
    filterMyProductsBtn.classList.replace('inactive-filter', 'active-filter');
    filterAllBtn.classList.replace('active-filter', 'inactive-filter');
    getProducts(currentFilter);
});
document.getElementById('create-product-empty-btn').addEventListener('click', openModalForCreate);
document.getElementById('close-modal-btn').addEventListener('click', closeModal);
document.getElementById('cancel-btn').addEventListener('click', closeModal);
form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const productId = productIdInput.value;
    const isEditMode = !!productId;
    
    const url = isEditMode ? `/edit-ajax/${productId}/` : `{% url 'main:create_product_ajax' %}`;
    const formData = new FormData(form);

    try {
        const response = await fetch(url, { method: 'POST', body: formData });
        const data = await response.json();
        if (data.status === 'success') {
            showToast(data.message, 'success');
            closeModal();
            getProducts(currentFilter);
        } else {
            showToast("Operasi gagal. Periksa kembali isian Anda.", 'error');
        }
    } catch (error) {
        showToast("Terjadi kesalahan pada server.", 'error');
    }
});
document.getElementById('product_cards').addEventListener('click', function(e) {
    const target = e.target.closest('button');
    if (!target) return;
    const productId = target.getAttribute('data-id');
    if (target.classList.contains('edit-btn')) {
        openModalForEdit(productId);
    } else if (target.classList.contains('delete-btn')) {
        openDeleteModal(productId);
    }
});
const deleteModal = document.getElementById('delete-confirm-modal');
const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
let productToDeleteId = null;
function openDeleteModal(id) {
    productToDeleteId = id;
    deleteModal.classList.remove('hidden');
}
function closeDeleteModal() {
    productToDeleteId = null;
    deleteModal.classList.add('hidden');
}
cancelDeleteBtn.addEventListener('click', closeDeleteModal);
confirmDeleteBtn.addEventListener('click', () => {
    if (productToDeleteId) {
        deleteProduct(productToDeleteId);
    }
});
async function deleteProduct(productId) {
    try {
        const response = await fetch(`/delete-ajax/${productId}/`, {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        });
        const data = await response.json();
        if (data.status === "success") {
            showToast(data.message, "success");
            getProducts(currentFilter);
        } else {
            showToast(data.message, "error");
        }
    } catch (error) {
        showToast("Terjadi kesalahan pada server.", "error");
    } finally {
        closeDeleteModal();
    }
}
async function addProduct() {
    const form = document.getElementById("add-product-form");
    try {
        const response = await fetch("{% url 'main:create_product_ajax' %}", {
            method: "POST",
            body: new FormData(form)
        });
        const data = await response.json();
        if (data.status === "success") {
            showToast(data.message, "success");
            closeModal();
            form.reset();
            getProducts(currentFilter);
        } else {
            showToast("Gagal menambahkan produk. Periksa kembali isian Anda.", "error");
        }
    } catch (error) {
        console.error("Error adding product:", error);
        showToast("Terjadi kesalahan pada server.", "error");
    }
}
</script>
{% endblock content %}